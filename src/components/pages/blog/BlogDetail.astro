---
import { marked } from 'marked'
import { Image } from 'astro:assets'
import Layout from '../../../layouts/Layout.astro'
import BlogPostSEO from '../../utils/BlogPostSEO.astro'
import ButtonCta from '../../atoms/ButtonCta'
import { useTranslations } from '../../../lib/i18n/utils'
import type { PostDetail } from '../../../types/blog'

interface Props {
  post: PostDetail
  lang: 'en' | 'es'
  translatedPath?: string
}

const { post, lang, translatedPath } = Astro.props
const t = useTranslations(lang)

const content = marked.parse(post.content)

// Format date
const date = new Date(post.created_at)
const formattedDate = date.toLocaleDateString(
  lang === 'es' ? 'es-MX' : 'en-US',
  {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  },
)

// Construct alternateUrls for SEO
// We assume translatedPath IS the alternate URL for the other language.
const alternateUrls = translatedPath
  ? {
      en: lang === 'en' ? Astro.url.pathname : translatedPath,
      es: lang === 'es' ? Astro.url.pathname : translatedPath,
    }
  : undefined
---

<Layout
  lang={lang}
  translatedPath={translatedPath}
>
  <BlogPostSEO
    slot='seo'
    postTitle={post.title}
    postExcerpt={post.description}
    postKeywords={post.keywords}
    postAuthor={post.author}
    postDate={post.created_at}
    postImageUrl={post.banner_image_url}
    postSlug={post.slug}
    alternateUrls={alternateUrls}
  />

  <section
    id='banner-image'
    class='parallax relative mx-auto mb-8 h-[300px] w-[98%] overflow-hidden rounded-xl md:h-[400px]'
  >
    <Image
      src={post.banner_image_url}
      alt={post.title}
      title={post.title}
      inferSize={true}
      loading='eager'
      fetchpriority='high'
      class='absolute -top-[20%] left-0 h-[140%] w-full object-cover'
    />
    <div class='bg-accent/60 absolute inset-0 mix-blend-multiply'></div>
    <div
      class='absolute inset-0 flex flex-col items-center justify-center p-4 text-center'
    >
      <div class='max-w-4xl'>
        <h1
          class='mb-4 text-3xl font-bold text-white! drop-shadow-md md:text-4xl lg:text-5xl'
        >
          {post.title}
        </h1>
        <div
          class='flex items-center justify-center gap-4 text-sm font-medium text-white/90 drop-shadow-sm md:text-base'
        >
          <span>{formattedDate}</span>
          <span>•</span>
          <span>{post.author}</span>
        </div>
      </div>
    </div>
  </section>

  <article class='container mx-auto max-w-4xl px-4 py-12'>
    <div
      class='prose prose-lg prose-blue prose-headings:font-bold prose-headings:text-gray-900 prose-a:text-accent hover:prose-a:text-accent-hover prose-img:rounded-xl prose-img:shadow-lg mx-auto max-w-none'
    >
      <div set:html={content} />
    </div>

    <div class='mt-12 flex justify-center'>
      <ButtonCta
        href={lang === 'es' ? '/es/blog' : '/blog'}
        variant='gray'
      >
        {lang === 'es' ? '← Volver al blog' : '← Back to Blog'}
      </ButtonCta>
    </div>
  </article>
</Layout>

<script>
  // Parallax
  const setupParallax = () => {
    const banner = document.querySelector('.parallax')
    if (!banner) return

    const img = banner.querySelector('img')
    if (!img) return

    let ticking = false
    const speed = 0.4

    const updatePosition = () => {
      const scrollY = window.scrollY
      // Optimization: Stop animating if banner is out of view
      if (scrollY > 600) return

      img.style.transform = `translateY(${scrollY * speed}px)`
      ticking = false
    }

    const onScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(updatePosition)
        ticking = true
      }
    }

    window.addEventListener('scroll', onScroll)

    // Cleanup on navigation
    const cleanup = () => {
      window.removeEventListener('scroll', onScroll)
      document.removeEventListener('astro:before-swap', cleanup)
    }

    document.addEventListener('astro:before-swap', cleanup)
  }

  document.addEventListener('astro:page-load', setupParallax)
</script>
