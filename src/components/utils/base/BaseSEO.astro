---
import { BUSINESS_DATA } from "../../../data/site-config";
import { SITE_TITLE, SITE_DESCRIPTION, LOCALE_MAP } from "../../../consts";
import {
  useTranslations,
  getLangFromUrl,
  getLocalizedPath,
} from "../../../lib/i18n/utils";

interface Props {
  currentPage?: string;
  title?: string;
  description?: string;
  jsonType?: string;
  extraJson?: Record<string, any>;
  ogImage?: string;
  noIndex?: boolean;
  baseDescription?: string;
  baseKeywords?: string;
  author?: string;
  useTagLine?: boolean;
}

const {
  currentPage,
  title,
  description: propDescription,
  jsonType = "LocalBusiness",
  extraJson = {},
  ogImage,
  noIndex = false,
  baseDescription = "",
  baseKeywords = "",
  author = BUSINESS_DATA.name,
  useTagLine = true,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const locale = LOCALE_MAP[lang] || "en_US";

// Metadata Resolution
const i18nTitle = currentPage ? t(`pages.${currentPage}.title`) : undefined;
const i18nDesc = currentPage
  ? t(`pages.${currentPage}.description`)
  : undefined;
const i18nKeywords = currentPage
  ? t(`pages.${currentPage}.keywords`)
  : undefined;

// Fallback logic: Prop > i18n > Constant > Default
const resolvedTitle = title || i18nTitle || SITE_TITLE;
const resolvedDescription =
  propDescription || baseDescription || i18nDesc || SITE_DESCRIPTION;
const resolvedKeywords = baseKeywords || i18nKeywords || "";

// Title Formatting (Tagline)
let pageTitle = resolvedTitle;
if (
  useTagLine &&
  resolvedTitle !== BUSINESS_DATA.name &&
  currentPage !== "home"
) {
  // Check if title already includes branding to avoid duplication
  if (!resolvedTitle.includes(BUSINESS_DATA.name)) {
    pageTitle = `${resolvedTitle} | ${BUSINESS_DATA.name}`;
  }
}

// Canonical & Alternates
const canonicalPath = currentPage
  ? getLocalizedPath(currentPage, lang)
  : Astro.url.pathname;
const canonicalUrl = `${BUSINESS_DATA.url}${canonicalPath}`;

const alternateUrls = currentPage
  ? {
      en: `${BUSINESS_DATA.url}${getLocalizedPath(currentPage, "en")}`,
      es: `${BUSINESS_DATA.url}${getLocalizedPath(currentPage, "es")}`,
    }
  : undefined;

// Images
const socialImage = ogImage || BUSINESS_DATA.ogImage || BUSINESS_DATA.logo;
const socialImageUrl = socialImage.startsWith("http")
  ? socialImage
  : `${BUSINESS_DATA.url}${socialImage}`;

// JSON-LD Construction - Conditionally build schema based on jsonType
// LocalBusiness-specific properties (not valid for TouristDestination, Service)
const isLocalBusiness =
  jsonType === "LocalBusiness" || jsonType === "TravelAgency";
const isTouristDestination = jsonType === "TouristDestination";
const isService = jsonType === "Service";

// Common schema properties for all schema types
const baseSchema: Record<string, any> = {
  "@context": "https://schema.org",
  "@type": jsonType,
  "@id": `${BUSINESS_DATA.url}#${jsonType.toLowerCase()}`,
  name: pageTitle,
  description: resolvedDescription,
  url: canonicalUrl,
  image: socialImageUrl,
  inLanguage: lang,
};

// Add LocalBusiness-specific properties
if (isLocalBusiness) {
  baseSchema.logo = `${BUSINESS_DATA.url}${BUSINESS_DATA.logo}`;
  baseSchema.email = BUSINESS_DATA.contact.email;
  baseSchema.telephone = BUSINESS_DATA.contact.phone;
  baseSchema.address = BUSINESS_DATA.contact.address;
  baseSchema.geo = BUSINESS_DATA.contact.geo;
  baseSchema.priceRange = "$$-$$$";
  baseSchema.openingHoursSpecification = {
    "@type": "OpeningHoursSpecification",
    dayOfWeek: [
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
      "Sunday",
    ],
    opens: "00:00",
    closes: "23:59",
  };
  baseSchema.sameAs = Object.values(BUSINESS_DATA.social);
  baseSchema.areaServed = [
    { "@type": "AdministrativeArea", name: "Yucatan" },
    { "@type": "Country", name: "Mexico" },
  ];
}

// Add TouristDestination-specific properties
if (isTouristDestination) {
  baseSchema.touristType = "Adventure travelers";
  baseSchema.containedInPlace = {
    "@type": "AdministrativeArea",
    name: "Riviera Maya, Mexico",
  };
}

// Add Service-specific properties
if (isService) {
  baseSchema.provider = {
    "@type": "LocalBusiness",
    name: BUSINESS_DATA.name,
    url: BUSINESS_DATA.url,
    telephone: BUSINESS_DATA.contact.phone,
  };
  baseSchema.areaServed = [
    { "@type": "AdministrativeArea", name: "Yucatan" },
    { "@type": "Country", name: "Mexico" },
  ];
  baseSchema.serviceType = "Airport Transportation";
}

const jsonLd = { ...baseSchema, ...extraJson };

const ogTypeMap: Record<string, string> = {
  LocalBusiness: "website",
  TravelAgency: "website",
  Blog: "blog",
  BlogPosting: "article",
};
const ogType = ogTypeMap[jsonType] || "website";
const keywordsContent = Array.isArray(resolvedKeywords)
  ? resolvedKeywords.join(", ")
  : resolvedKeywords;
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{pageTitle}</title>
<meta name="description" content={resolvedDescription} />
{keywordsContent && <meta name="keywords" content={keywordsContent} />}
<meta name="author" content={author} />
<link rel="canonical" href={canonicalUrl} />

<!-- Robots -->
{noIndex && <meta name="robots" content="noindex, nofollow" />}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={resolvedDescription} />
<meta property="og:image" content={socialImageUrl} />
<meta property="og:locale" content={locale} />
<meta property="og:site_name" content={BUSINESS_DATA.name} />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalUrl} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={resolvedDescription} />
<meta name="twitter:image" content={socialImageUrl} />

<!-- Alternates -->
{
  alternateUrls && (
    <>
      <link rel="alternate" hreflang="en" href={alternateUrls.en} />
      <link rel="alternate" hreflang="es" href={alternateUrls.es} />
    </>
  )
}

<!-- JSON-LD -->
<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
<link rel="sitemap" href="/sitemap-index.xml" />
