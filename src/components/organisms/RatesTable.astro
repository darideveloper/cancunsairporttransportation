---
// Libs
import { getLangFromUrl, getTranslations } from "../../lib/i18n/utils";
import { getFormattedPrice } from "../../lib/utils";
import { BASE_PRICES, type ServiceTier } from "../../data/prices";
import clsx from "clsx";

// Components
import SectionHeading from "../molecules/SectionHeading.astro";

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// Props
interface Props {
  /**
   * Optional: Filter to specific destinations by key.
   * If not provided, all destinations will be shown.
   */
  destinations?: string[];
}

const { destinations: destinationFilter } = Astro.props;

// Get headers translation object
const headers = t("global.ratesTable.headers") as Record<string, string>;

// Build destination data from centralized prices
interface DestinationRow {
  name: string;
  privateOw: string;
  privateRt: string;
  luxuryOw: string;
  luxuryRt: string;
  groupOw: string;
  groupRt: string;
}

// Get all destinations from the centralized pricing data
const allDestinationKeys = Object.keys(BASE_PRICES);
const destinationKeys = destinationFilter ?? allDestinationKeys;

const destinations: DestinationRow[] = destinationKeys
  .filter((key) => BASE_PRICES[key]) // Ensure key exists
  .map((key) => {
    const dest = BASE_PRICES[key];
    const pricing = dest.pricing;

    return {
      name: t(dest.nameKey) as string,
      privateOw: getFormattedPrice(pricing.private?.ow, lang),
      privateRt: getFormattedPrice(pricing.private?.rt, lang),
      luxuryOw: getFormattedPrice(pricing.luxury?.ow, lang),
      luxuryRt: getFormattedPrice(pricing.luxury?.rt, lang),
      groupOw: getFormattedPrice(pricing.group?.ow, lang),
      groupRt: getFormattedPrice(pricing.group?.rt, lang),
    };
  });

const SERVICE_TIERS = [
  {
    id: "private",
    label: headers.private,
    pax: headers.pax1to8,
    owKey: "privateOw" as const,
    rtKey: "privateRt" as const,
  },
  {
    id: "luxury",
    label: headers.luxury,
    pax: headers.pax1to5,
    owKey: "luxuryOw" as const,
    rtKey: "luxuryRt" as const,
  },
  {
    id: "group",
    label: headers.group,
    pax: headers.pax1to16,
    owKey: "groupOw" as const,
    rtKey: "groupRt" as const,
  },
];

const STICKY_SHADOW_CLASSES =
  "after:absolute after:inset-y-0 after:right-0 after:w-4 after:translate-x-full after:bg-linear-to-r after:from-black/5 after:to-transparent after:content-[''] after:pointer-events-none lg:after:hidden";

// Calculate visibility for each tier and column
const visibleServiceTiers = SERVICE_TIERS.map((tier) => {
  const hasOw = destinations.some(
    (dest) => dest[tier.owKey] && dest[tier.owKey] !== "N/A",
  );
  const hasRt = destinations.some(
    (dest) => dest[tier.rtKey] && dest[tier.rtKey] !== "N/A",
  );

  return {
    ...tier,
    hasOw,
    hasRt,
    isVisible: hasOw || hasRt,
    colspan: (hasOw ? 1 : 0) + (hasRt ? 1 : 0),
  };
}).filter((tier) => tier.isVisible);
---

<section
  class="container mt-12"
  id="rates-table"
  aria-labelledby="rates-table-heading"
>
  <SectionHeading
    id="rates-table-heading"
    title={t("global.ratesTable.title")}
    class="mb-8 text-center"
  >
    <p>{t("global.ratesTable.description")}</p>
  </SectionHeading>
  <div class="w-full overflow-x-auto rounded-xl">
    <table
      class="w-full min-w-[800px] border-collapse text-left text-xs sm:text-sm"
    >
      <caption class="sr-only"
        >{t("global.ratesTable.title")} - {
          t("global.ratesTable.description")
        }</caption
      >
      <thead class="sticky top-0 z-10 font-bold">
        <tr>
          <th
            scope="col"
            class={clsx(
              "text-blue-dark border-gray/50 sticky left-0 z-30 border-t border-b bg-white px-2 py-4 text-center align-bottom font-bold md:px-6",
              STICKY_SHADOW_CLASSES,
            )}
            rowspan="2"
          >
            {headers.destination}
          </th>
          {
            visibleServiceTiers.map((tier) => (
              <th
                scope="colgroup"
                class="text-blue-dark border-gray/50 border-t border-b bg-white px-6 py-4 text-center font-bold"
                colspan={tier.colspan}
              >
                {tier.label} <br /> {tier.pax}
              </th>
            ))
          }
        </tr>
        <tr>
          {
            visibleServiceTiers.map((tier) => (
              <>
                {tier.hasOw && (
                  <th
                    scope="col"
                    class="text-blue-dark border-gray/50 border-b bg-white px-6 py-4 text-center font-bold tracking-wider capitalize"
                  >
                    {headers.oneWay}
                  </th>
                )}
                {tier.hasRt && (
                  <th
                    scope="col"
                    class="text-blue-dark border-gray/50 border-b bg-white px-6 py-4 text-center font-bold tracking-wider capitalize"
                  >
                    {headers.roundTrip}
                  </th>
                )}
              </>
            ))
          }
        </tr>
      </thead>
      <tbody
        class="[&>tr:not(:first-child)>*]:border-gray-light [&>tr:not(:first-child)>*]:border-t"
      >
        {
          destinations.map((dest, index) => (
            <tr class={clsx(index % 2 === 0 ? "bg-white" : "bg-gray/10")}>
              <th
                scope="row"
                class={clsx(
                  "text-gray-dark sticky left-0 z-20 border-0 px-2 py-4 font-medium whitespace-nowrap md:px-6",
                  index % 2 === 0 ? "bg-white" : "bg-[#F1F1F1]",
                  STICKY_SHADOW_CLASSES,
                )}
              >
                {dest.name}
              </th>
              {visibleServiceTiers.map((tier) => (
                <>
                  {tier.hasOw && (
                    <td class="border-gray-light border-0 px-4 py-4 text-center whitespace-nowrap">
                      {dest[tier.owKey]}
                    </td>
                  )}
                  {tier.hasRt && (
                    <td class="border-gray-light border-0 px-4 py-4 text-center whitespace-nowrap">
                      {dest[tier.rtKey]}
                    </td>
                  )}
                </>
              ))}
            </tr>
          ))
        }
      </tbody>
    </table>
  </div>
</section>
