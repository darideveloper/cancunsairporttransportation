---
import { useTranslations, getLangFromUrl } from "../../lib/i18n/utils";
import { getFormattedPrice } from "../../lib/utils";
import { getOneWayPrice, PAGE_DESTINATION_MAP } from "../../data/prices";
import SectionHeading from "../molecules/SectionHeading.astro";
import FaqItem from "../molecules/FaqItem.astro";

import { marked } from "marked";

interface Props {
  contentKey: string; // e.g., "home", "playaDelCarmen"
}

const { contentKey } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const title = t(`pages.${contentKey}.faq.title`);
const description = t("global.sections.faq.description");

const faqItems = t(`pages.${contentKey}.faq.items`) as any;
const faqKeys = Object.keys(faqItems);

// Price Interpolation Logic
const destinationKey = PAGE_DESTINATION_MAP[contentKey];
let formattedPrivateOw = "N/A";

if (destinationKey) {
  const price = getOneWayPrice(destinationKey, "private");
  formattedPrivateOw = getFormattedPrice(price, lang, {
    includeCurrency: true,
  });
}

const processAnswer = (text: string) => {
  if (!text) return "";
  // strict replacement for the current page's price
  // We handle both the standard {pricePrivateOw} and the legacy specific keys which will be cleaned up
  return text
    .replace(/{pricePrivateOw}/g, formattedPrivateOw)
    .replace(/{priceTulumPrivateOw}/g, formattedPrivateOw)
    .replace(/{priceAkumalPrivateOw}/g, formattedPrivateOw);
};
---

<section
  class="container mt-12"
  id="faq-section"
  aria-labelledby="faq-section-heading"
>
  <SectionHeading
    id="faq-section-heading"
    title={title}
    class="mb-8 text-center"
  >
    <p>{description}</p>
  </SectionHeading>

  <div class="flex flex-col gap-4">
    {
      faqKeys.map((key) => (
        <FaqItem
          question={faqItems[key].question}
          answer={marked.parse(processAnswer(faqItems[key].answer)) as string}
        />
      ))
    }
  </div>
</section>
