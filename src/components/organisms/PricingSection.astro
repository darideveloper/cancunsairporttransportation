---
import { getTranslations, getLangFromUrl } from "../../lib/i18n/utils";
import { getPriceValue, getCurrencyCode } from "../../lib/utils";
import { BASE_PRICES, PAGE_DESTINATION_MAP } from "../../data/prices";
import SectionHeading from "../molecules/SectionHeading.astro";
import PricingCard from "../molecules/PricingCard.astro";
import { Image } from "astro:assets";
import { marked } from "marked";

// Images
import luxuryVehicleImg from "../../assets/images/vehicles/luxury.webp";
import privateVehicleImg from "../../assets/images/vehicles/standard.webp";
import groupVehicleImg from "../../assets/images/vehicles/groups.webp";

interface Props {
  contentKey: string; // e.g., "home", "playaDelCarmen"
  isRegularGrid?: boolean;
}

const { contentKey, isRegularGrid = false } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const pricingKeys = ["luxury", "private", "group"] as const;

const vehicleImages = {
  luxury: luxuryVehicleImg,
  private: privateVehicleImg,
  group: groupVehicleImg,
};

const title = t(`pages.${contentKey}.pricing.title`);
const subtitle = t(`pages.${contentKey}.pricing.subtitle`);

// Map service tier keys to destination pricing keys
const tierToDestinationKey = {
  luxury: "luxury",
  private: "private",
  group: "group",
} as const;

// Get the destination key for this page (fallback to cancunZone if not found)
const destinationKey = PAGE_DESTINATION_MAP[contentKey] || "cancunZone";
const destinationPricing = BASE_PRICES[destinationKey]?.pricing;
---

<section
  id="pricing-transportation"
  class="container mt-12"
  aria-labelledby="pricing-transportation-heading"
>
  <SectionHeading
    id="pricing-transportation-heading"
    title={title}
    class="text-center"
  >
    <p>
      {subtitle}
    </p>
  </SectionHeading>

  <ul
    class="mt-4 grid grid-cols-1 items-end justify-center gap-4 md:grid-cols-3 md:flex-row"
    role="list"
  >
    {
      pricingKeys.map((key) => {
        const globalData = t(
          `global.sections.pricingServices.cards.${key}`,
        ) as any;
        const pageData = t(`pages.${contentKey}.pricing.cards.${key}`) as any;

        // Get the price from centralized pricing data
        const tierKey = tierToDestinationKey[key];
        const tierPricing = destinationPricing?.[tierKey];
        const usdPrice = tierPricing?.ow ?? null;

        // Format the price value (just the number, without currency symbol)
        const price = getPriceValue(usdPrice, lang);
        const currency = getCurrencyCode(lang);

        return (
          <li class={`${isRegularGrid && "h-full"}`}>
            <PricingCard
              title={pageData.title}
              price={price}
              ctaLink="#booking-form"
              ctaText={globalData.ctaText}
              bestSeller={globalData.bestSeller}
              currency={currency}
              class="pt-4"
            >
              <Image
                slot="image"
                src={vehicleImages[key]}
                alt={globalData.imageAlt}
                title={globalData.imageTitle}
                widths={[200, 400]}
                quality={60}
                format="avif"
                loading="lazy"
                decoding="async"
                class="mx-auto w-8/12"
              />
              <div
                slot="content"
                set:html={marked.parse(
                  `${pageData.description}\n\n* ${t("global.ui.pricingCard.features.privateService")}\n* ${t("global.ui.pricingCard.features.taxesIncluded")}\n* ${t("global.ui.pricingCard.features.service24h")}`,
                )}
                class="markdown"
              />
            </PricingCard>
          </li>
        );
      })
    }
  </ul>
</section>
