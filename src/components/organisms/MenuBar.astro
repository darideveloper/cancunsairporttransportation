---
// Libs
import {
  getLangFromUrl,
  useTranslations,
  getLocalizedPath,
} from "../../lib/i18n/utils";

// Data
import { PHONES } from "../../data/site-config";

// Icons
import { TiThMenu as MenuIcon } from "react-icons/ti";
import { IoClose as CloseIcon } from "react-icons/io5";

// Components
import Logo from "../atoms/Logo.astro";
import ButtonCta from "../atoms/ButtonCta.astro";
import NavLinks from "../molecules/NavLinks.astro";
import NavLink from "../atoms/NavLink.astro";

// Styles
import { MOBILE_MENU_STYLES as MOBILE_STYLES } from "../../styles/menu";

interface Props {
  pageKey?: string;
}

const { pageKey } = Astro.props;

// Lang
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Constants & Data
const CTA_LINK = getLocalizedPath("reservation", lang);
const CTA_LABEL = t("global.menubar.cta");

const contactPhones = [
  {
    link: PHONES.mexico.href,
    label: PHONES.mexico.formatted,
    name: t("global.topbar.mexicoPhone"),
  },
  {
    link: PHONES.usa.href,
    label: PHONES.usa.formatted,
    name: t("global.topbar.usaPhone"),
  },
];

const targetLang = lang === "es" ? "en" : "es";
const translateLink = pageKey
  ? getLocalizedPath(pageKey, targetLang)
  : targetLang === "es"
    ? "/es"
    : "/";
---

<div class="menu-bar shadow-gray/8 w-full shadow-xl">
  <div
    id="menu-bar"
    class="container mx-auto flex w-full max-w-[1750px] items-center justify-between py-4"
  >
    <!-- logo -->
    <Logo />

    <!-- navigation -->
    <nav aria-label={t("global.menubar.nav.ariaLabel") || "Main Navigation"}>
      <NavLinks mode="desktop" />
    </nav>

    <!-- cta -->
    <ButtonCta href={CTA_LINK} class="hidden! lg:block!">
      {CTA_LABEL}
    </ButtonCta>

    <!-- mobile menu open button -->
    <button
      id="menu-open-button"
      aria-label="Open main menu"
      aria-expanded="false"
      aria-controls="menu-bar-mobile"
      class="text-yellow border-yellow inline-block cursor-pointer rounded-xl border-2 p-3 text-3xl lg:hidden"
    >
      <MenuIcon />
    </button>
  </div>

  <!-- mobile menu bar -->
  <div
    class="invisible fixed top-0 left-0 z-50 h-screen w-full translate-x-full overflow-y-auto bg-white transition-transform duration-300 ease-in-out"
    id="menu-bar-mobile"
    aria-hidden="true"
  >
    <!-- menu top bar -->
    <div class="flex w-full justify-between px-4 py-8">
      <!-- Top "Menu" text -->
      <div class="menu-text flex items-center justify-center gap-4">
        <MenuIcon className="text-blue text-2xl" />
        <p class="text-xl">
          {t("global.menubar.topSection.text")}
        </p>
      </div>

      <!-- Close button -->
      <button
        id="menu-close-button"
        aria-label="Close menu"
        aria-controls="menu-bar-mobile"
        class="text-blue border-blue inline-block cursor-pointer rounded-xl border-2 p-2 text-4xl lg:hidden"
      >
        <CloseIcon />
      </button>
    </div>

    <!-- Duplicate nav -->
    <nav aria-label="Mobile Navigation">
      <NavLinks mode="mobile">
        <!-- Mobile Extras -->
        <li class={MOBILE_STYLES.li}>
          <p><strong>{t("global.menubar.translateWebsite")}</strong></p>
        </li>
        <li class={MOBILE_STYLES.li}>
          <NavLink
            link={translateLink}
            label={t("global.menubar.translateWebsiteText")}
            class={MOBILE_STYLES.link}
          />
        </li>
        <li class={MOBILE_STYLES.li}>
          <p>
            <strong>{t("global.menubar.customerService.title")}</strong>
          </p>
          <p class="mt-2">{t("global.menubar.customerService.body")}</p>
        </li>

        {
          contactPhones.map((phone) => (
            <li class={MOBILE_STYLES.li}>
              <NavLink
                link={phone.link}
                label={phone.label}
                ariaLabel={t("global.accessibility.callAction", {
                  label: phone.name,
                  phone: phone.label,
                })}
                class={MOBILE_STYLES.link}
              />
            </li>
          ))
        }
      </NavLinks>
    </nav>

    <!-- cta -->
    <div class="flex w-full justify-center">
      <ButtonCta
        href={CTA_LINK}
        class="bg-yellow hover:bg-yellow-dark mx-auto my-10 inline-block w-11/12 font-bold text-black"
      >
        {CTA_LABEL}
      </ButtonCta>
    </div>
  </div>
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const menuBarMobile = document.getElementById("menu-bar-mobile");
    const menuOpenButton = document.getElementById("menu-open-button");
    const menuCloseButton = document.getElementById("menu-close-button");

    let menuTimeout: ReturnType<typeof setTimeout>;

    const toggleMenu = (show: boolean) => {
      if (!menuBarMobile || !menuOpenButton || !menuCloseButton) return;

      clearTimeout(menuTimeout);

      if (show) {
        menuBarMobile.classList.remove("invisible");
        menuBarMobile.classList.remove("translate-x-full");
        menuBarMobile.setAttribute("aria-hidden", "false");
        menuOpenButton.setAttribute("aria-expanded", "true");
        menuCloseButton.focus();
      } else {
        menuBarMobile.classList.add("translate-x-full");
        menuBarMobile.setAttribute("aria-hidden", "true");
        menuOpenButton.setAttribute("aria-expanded", "false");
        menuOpenButton.focus();

        // Wait for the transition to finish before hiding the element
        menuTimeout = setTimeout(() => {
          menuBarMobile.classList.add("invisible");
        }, 300);
      }
    };

    if (menuOpenButton) {
      menuOpenButton.addEventListener("click", () => toggleMenu(true));
    }

    if (menuCloseButton) {
      menuCloseButton.addEventListener("click", () => toggleMenu(false));
    }

    // Focus trap implementation
    menuBarMobile?.addEventListener("keydown", (e) => {
      if (!menuBarMobile || menuBarMobile.classList.contains("invisible"))
        return;

      const focusableElements = menuBarMobile.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      );
      const firstFocusableElement = focusableElements[0] as HTMLElement;
      const lastFocusableElement = focusableElements[
        focusableElements.length - 1
      ] as HTMLElement;

      if (e.key === "Tab") {
        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      }

      if (e.key === "Escape") {
        toggleMenu(false);
      }
    });
  });
</script>
